<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ESP32 Heart Rate Monitor</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="main">
    <h1>ESP32 HEART RATE MONITOR AND FALL DETECTION</h1>
    <div id="alert-box"></div>

    <!-- Hai v√≤ng tr√≤n -->
    <div class="container">
      <!-- Heart Rate -->
      <div class="circle-container">
        <svg class="circle" width="400" height="400">
          <circle class="bg" cx="200" cy="200" r="170"></circle>
          <circle class="progress" id="hr-circle" cx="200" cy="200" r="170"></circle>
        </svg>
        <div class="value" id="hr-value">0 BPM</div>
        <p>Heart Rate</p>
      </div>

      <!-- SpO2 -->
      <div class="circle-container">
        <svg class="circle" width="400" height="400">
          <circle class="bg" cx="200" cy="200" r="170"></circle>
          <circle class="progress" id="spo2-circle" cx="200" cy="200" r="170"></circle>
        </svg>
        <div class="value" id="spo2-value">0%</div>
        <p>SpO‚ÇÇ</p>
      </div>
    </div>

    <!-- L·ªãch s·ª≠ c·∫£nh b√°o -->
    <div id="history-section">
      <h2>L·ªãch s·ª≠ c·∫£nh b√°o</h2>
      <ul id="history-list"></ul>
    </div>

    <!-- N√∫t b·∫≠t / t·∫Øt -->
    <button id="toggle-history">‚ñ≤ ·∫®n l·ªãch s·ª≠</button>
  </div>

  <audio id="alert-sound" src="alert-33762.mp3" preload="auto"></audio>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

  <script>
    // ‚úÖ C·∫•u h√¨nh Firebase
    var firebaseConfig = {
      apiKey: "AIzaSyAULCcxzxiS9qHxD5Qmq2O0cw3IfcvbICU",
      authDomain: "heartratemonitor-2c056.firebaseapp.com",
      databaseURL: "https://heartratemonitor-2c056-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "heartratemonitor-2c056",
      storageBucket: "heartratemonitor-2c056.firebasestorage.app",
      messagingSenderId: "717061120649",
      appId: "1:717061120649:web:c63748500b40b118d51c58"
    };

    // ‚úÖ Kh·ªüi t·∫°o Firebase
    firebase.initializeApp(firebaseConfig);
    var database = firebase.database();

    // ‚úÖ H√†m x·ª≠ l√Ω hi·ªÉn th·ªã v√† c·∫£nh b√°o
    function updateCircle(id, value, max, colorCondition) {
      const circle = document.getElementById(id);
      const radius = 110;
      const circumference = 2 * Math.PI * radius;
      const offset = circumference - (value / max) * circumference;

      circle.style.strokeDasharray = circumference;
      circle.style.strokeDashoffset = offset;
      circle.style.stroke = colorCondition ? "red" : "limegreen";
    }

    function playAlertSound(active) {
      const alertSound = document.getElementById("alert-sound");
      if (active) {
        if (alertSound.paused) alertSound.play();
      } else {
        alertSound.pause();
        alertSound.currentTime = 0;
      }
    }

    function showAlert(message) {
      const box = document.getElementById("alert-box");
      box.textContent = message;
      box.style.display = "block";
      clearTimeout(window.alertTimeout);
      window.alertTimeout = setTimeout(() => {
        box.style.display = "none";
      }, 3000);
    }

    // ‚úÖ C·∫≠p nh·∫≠t d·ªØ li·ªáu v√† l∆∞u l·ªãch s·ª≠
    function updateData(heartRate, spo2) {
      document.getElementById("hr-value").textContent = heartRate + " BPM";
      document.getElementById("spo2-value").textContent = spo2 + "%";

      const hrAlert = heartRate > 100 || heartRate < 50;
      const spo2Alert = spo2 < 95;

      updateCircle("hr-circle", heartRate, 150, hrAlert);
      updateCircle("spo2-circle", spo2, 100, spo2Alert);

      playAlertSound(hrAlert || spo2Alert);

      if (hrAlert || spo2Alert) {
        const alertMsg = hrAlert
          ? `‚ö†Ô∏è Nh·ªãp tim b·∫•t th∆∞·ªùng (${heartRate} BPM)`
          : `‚ö†Ô∏è SpO‚ÇÇ th·∫•p (${spo2}%)`;

        showAlert(alertMsg);

        const now = new Date();
        const timestamp = now.toLocaleString();

        // üîπ Ghi l·ªãch s·ª≠ v√†o Firebase
        const historyRef = database.ref("AlertHistory");
        historyRef.push({
          timestamp: timestamp,
          message: alertMsg,
          heartRate: heartRate,
          spo2: spo2
        });
      }
    }

    // ‚úÖ L·∫Øng nghe d·ªØ li·ªáu realtime t·ª´ Firebase
    var heartRef = database.ref("HeartRate");
    var spo2Ref = database.ref("Sp02");

    heartRef.on("value", function(snapshot) {
      var heartRate = snapshot.val();
      spo2Ref.once("value").then(function(spSnap) {
        var spo2 = spSnap.val();
        updateData(heartRate, spo2);
      });
    });

    // ‚úÖ Hi·ªÉn th·ªã l·ªãch s·ª≠ c·∫£nh b√°o realtime
    var historyList = document.getElementById("history-list");
    var historyRef = database.ref("AlertHistory");

    historyRef.on("child_added", function(snapshot) {
      var data = snapshot.val();
      var li = document.createElement("li");
      li.innerHTML = `
        <strong>${data.timestamp}</strong><br>
        ${data.message}<br>
        ‚ù§Ô∏è Heart Rate: <b>${data.heartRate} BPM</b> | ü©∏ SpO‚ÇÇ: <b>${data.spo2}%</b>
      `;
      historyList.prepend(li);
    });

    // ‚úÖ N√∫t ·∫©n / hi·ªán khung l·ªãch s·ª≠
    const toggleBtn = document.getElementById("toggle-history");
    const historySection = document.getElementById("history-section");
    let isVisible = true;

    toggleBtn.addEventListener("click", () => {
      isVisible = !isVisible;
      historySection.classList.toggle("hidden", !isVisible);
      toggleBtn.innerHTML = isVisible ? "‚ñ≤ ·∫®n l·ªãch s·ª≠" : "‚ñº Hi·ªán l·ªãch s·ª≠";
    });
  </script>
</body>
</html>
