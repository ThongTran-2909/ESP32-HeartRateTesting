<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ESP32 Heart Rate Monitor</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="main">
    <h1>ESP32 HEART RATE MONITOR AND FALL DETECTION</h1>
    <div id="alert-box"></div>

    <div class="container">
      <div class="circle-container">
        <svg class="circle" width="400" height="400">
          <circle class="bg" cx="200" cy="200" r="170"></circle>
          <circle class="progress" id="hr-circle" cx="200" cy="200" r="170"></circle>
        </svg>
        <div class="value" id="hr-value">0 BPM</div>
        <p>Heart Rate</p>
      </div>

      <div class="circle-container">
        <svg class="circle" width="400" height="400">
          <circle class="bg" cx="200" cy="200" r="170"></circle>
          <circle class="progress" id="spo2-circle" cx="200" cy="200" r="170"></circle>
        </svg>
        <div class="value" id="spo2-value">0%</div>
        <p>SpO‚ÇÇ</p>
      </div>
    </div>

    <div id="history-section">
      <h2>L·ªãch s·ª≠ c·∫£nh b√°o</h2>
      <ul id="history-list"></ul>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
      <button id="toggle-history">‚ñ≤ ·∫®n l·ªãch s·ª≠</button>
      <button id="reset-history" >
        üóëÔ∏è X√≥a l·ªãch s·ª≠
      </button>
    </div>
  </div>

  <audio id="alert-sound" src="alert-33762.mp3" preload="auto"></audio>

  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyAULCcxzxiS9qHxD5Qmq2O0cw3IfcvbICU",
      authDomain: "heartratemonitor-2c056.firebaseapp.com",
      databaseURL: "https://heartratemonitor-2c056-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "heartratemonitor-2c056",
      storageBucket: "heartratemonitor-2c056.firebasestorage.app",
      messagingSenderId: "717061120649",
      appId: "1:717061120649:web:c63748500b40b118d51c58"
    };

    firebase.initializeApp(firebaseConfig);
    var database = firebase.database();

    function updateCircle(id, value, max, colorCondition) {
      const circle = document.getElementById(id);
      const radius = 110;
      const circumference = 2 * Math.PI * radius;
      const offset = circumference - (value / max) * circumference;
      circle.style.strokeDasharray = circumference;
      circle.style.strokeDashoffset = offset;
      circle.style.stroke = colorCondition ? "red" : "limegreen";
    }

    function playAlertSound(active) {
      const alertSound = document.getElementById("alert-sound");
      if (active) {
        if (alertSound.paused) alertSound.play();
      } else {
        alertSound.pause();
        alertSound.currentTime = 0;
      }
    }

    function showAlert(message) {
      const box = document.getElementById("alert-box");
      box.textContent = message;
      box.style.display = "block";
      clearTimeout(window.alertTimeout);
      window.alertTimeout = setTimeout(() => {
        box.style.display = "none";
      }, 3000);
    }

    function updateData(heartRate, spo2) {
      document.getElementById("hr-value").textContent = heartRate + " BPM";
      document.getElementById("spo2-value").textContent = spo2 + "%";

      const hrAlert = heartRate > 100 || heartRate < 50;
      const spo2Alert = spo2 < 95;

      updateCircle("hr-circle", heartRate, 150, hrAlert);
      updateCircle("spo2-circle", spo2, 100, spo2Alert);

      playAlertSound(hrAlert || spo2Alert);

      if (hrAlert || spo2Alert) {
        const alertMsg = hrAlert
          ? `‚ö†Ô∏è Nh·ªãp tim b·∫•t th∆∞·ªùng (${heartRate} BPM)`
          : `‚ö†Ô∏è SpO‚ÇÇ th·∫•p (${spo2}%)`;

        showAlert(alertMsg);

        const now = new Date();
        const timestamp = now.toLocaleString();
        const dateValue = now.getTime();
        const dateKey = now.toISOString().split("T")[0];

        const historyRef = database.ref("AlertHistory/" + dateKey);
        historyRef.push({
          timestamp: timestamp,
          dateValue: dateValue,
          message: alertMsg,
          heartRate: heartRate,
          spo2: spo2
        });
      }
    }

    var heartRef = database.ref("HeartRate");
    var spo2Ref = database.ref("Sp02");

    heartRef.on("value", function(snapshot) {
      var heartRate = snapshot.val();
      spo2Ref.once("value").then(function(spSnap) {
        var spo2 = spSnap.val();
        updateData(heartRate, spo2);
      });
    });

    var historyList = document.getElementById("history-list");
    var mainHistoryRef = database.ref("AlertHistory");

    mainHistoryRef.on("value", function(snapshot) {
      historyList.innerHTML = "";
      const dateEntries = [];

      snapshot.forEach(function(dateSnap) {
        dateEntries.push({
          dateKey: dateSnap.key,
          data: dateSnap.val()
        });
      });

      dateEntries.sort((a, b) => b.dateKey.localeCompare(a.dateKey));

      dateEntries.forEach((day) => {
        const header = document.createElement("h3");
        const dateLabel = new Date(day.dateKey).toLocaleDateString("vi-VN");
        header.textContent = `üìÖ Ng√†y ${dateLabel}`;
        header.style.color = "#d32f2f";
        header.style.marginTop = "10px";
        historyList.appendChild(header);

        const alerts = Object.values(day.data).sort((a, b) => b.dateValue - a.dateValue);

        alerts.forEach((data) => {
          const li = document.createElement("li");
          li.innerHTML = `
            <strong>${data.timestamp}</strong>
            
            ${data.message}<br>
            ‚ù§Ô∏è Heart Rate: <b>${data.heartRate} BPM</b> | ü©∏ SpO‚ÇÇ: <b>${data.spo2}%</b>
          `;
          historyList.appendChild(li);
        });
      });
    });

    const toggleBtn = document.getElementById("toggle-history");
    const resetBtn = document.getElementById("reset-history");
    const historySection = document.getElementById("history-section");
    let isVisible = true;

    toggleBtn.addEventListener("click", () => {
      isVisible = !isVisible;
      historySection.classList.toggle("hidden", !isVisible);
      toggleBtn.innerHTML = isVisible ? "‚ñ≤ ·∫®n l·ªãch s·ª≠" : "‚ñº Hi·ªán l·ªãch s·ª≠";
    });

    resetBtn.addEventListener("click", () => {
      if (confirm("‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ c·∫£nh b√°o kh√¥ng?")) {
        database.ref("AlertHistory").remove()
          .then(() => {
            alert("‚úÖ L·ªãch s·ª≠ ƒë√£ ƒë∆∞·ª£c x√≥a!");
            historyList.innerHTML = "";
          })
          .catch((error) => {
            alert("‚ùå L·ªói khi x√≥a l·ªãch s·ª≠: " + error.message);
          });
      }
    });
  </script>
</body>
</html>
